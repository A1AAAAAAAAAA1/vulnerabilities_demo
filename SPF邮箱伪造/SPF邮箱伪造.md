## SPF邮箱伪造

## SPF介绍

发送者策略框架 (Sender Policy Framework, SPF) 和 DMARC 还有 DKIM 一起，在邮件验证中扮演重要的角色。它能够防止来自未经授权的发送者的邮件抵达收件箱。

#### 什么是发送者策略框架 (Sender Policy Framework, SPF)

发送者策略框架 (Sender Policy Framework, SPF) 是一个电子邮件验证机制，它使得仅有被授权的发送者可以代表域名发送邮件，并且阻止其他所有未经授权的发送者这样做。SPF 使接收服务器能够检查一封声称来自一个特定域名的邮件是否来自一个域名管理者指定的 IP 地址。

#### 为什么要 SPF

电子邮件本来并没有被设计成一个安全的通讯平台 - 任何人都可以以任何域名的名义发送邮件。这让网络攻击者盗取邮件接收者的敏感信息，比如信用卡信息和密码成为可能。

SPF 被设计来解决这个特定的问题：当 SPF 在域名上面正确地设置了以后，与 SPF 兼容的邮箱服务提供商会检查进来的邮件是否来自允许代表该域名的主机。如果是这样的话，邮件被称为被 SPF 验证，并且会被投递到收件箱。否则，会对邮件执行其他检查，并且根据检查结果和 DMARC 设置，可能会被隔离或者拒收。

#### SPF 的好处

SPF 提供了验证邮件发送者的机制 - 这确保指定的白名单以外的主机无法代表域名发送邮件。这从根本上杜绝了一大类的冒名攻击。

简单地说：

- 没有 SPF：任何主机都可以使用域名发送邮件；
- 使用 SPF：只有白名单中指定的主机可以使用域名发送邮件。

#### SPF 不能做什么

电子邮件中有两类 From 地址：envelope From 地址和头域 From 地址。SPF 仅验证 envelope From 地址，但是并不验证头域 From 地址。DMARC 引入 "SPF identifier alignment" 的概念来解决这个问题。

## 绕过方式

https://www.freebuf.com/articles/system/238215.html

**1、SPF解析不当导致绕过**

假设我的SPF记录设置为：`v=spf1 ip4:220.xxx.10.0/24 ~all`，

这条SPF记录的意思是说只允许`220.xxx.10.1~220.xxx.10.255` 范围内的IP，软拒绝，发件 IP 非法，但是不采取强硬措施。

这就存在两个严重的安全隐患：

一个是IP段过大，在C段里面，只要获取任意一台主机的权限，那么就可以使用合法的IP进行邮件伪造。

一个是软拒绝，也就是会接受来信，但可能被标记为垃圾邮件。如果SPF记录设置拒绝，就会有大量的邮件被丢弃或者隔离，影响办公效率，有一些邮件系统管理员为了减少业务影响，而采用软拒绝的策略。

当SPF记录设置成~all时，通过测试可以发现，outlook邮箱可以接收邮件，QQ邮箱不接收，163邮箱被标记为垃圾邮件。

还有一种极为严重的错误，就是SPF解析记录配置错误，早在之前鹅厂就出现过SPF解析错误，比如：

```
v=spf1 ip4:113.110.223.0/24 183.110.226.0/24 183.110.255.0/24 59.110.132.0/24 -all
```

这里介绍一个工具，输入域名和SPF记录，可快速检查SPF记录是否正确

测试地址：https://www.kitterman.com/spf/validate.html

### 



